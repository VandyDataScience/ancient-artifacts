---
title: "40-modeling"
output: html_document
---

This model will end up containing some generalized method that we'll use for all the models.  This will aid us in maintainability of our codebase, and also help us avoid copy/paste (and lack thereof) replication errors.

**Note that this notebook requires 10 to already have been run.**

```{r modeling imports}
pacman::p_load(tidymodels, usemodels)
```

# Split the data
In this step, we perform a general data split as normal.  We'll split with 75% to training and the other 25% to testing, stratified by the class.  Note that we want to abstain from looking at the performance on the test data until the _very, VERY_ end.  We might also want to think about unsetting this seed once the code is developed, and just recording whatever seed is randomly generated.  This will allow us some variation on our generated data.

```{r ml data split}
set.seed(2434)
data_split <- initial_split(artifact_data, prop=3/4, strata=particle_class)

train_data <- training(data_split)
test_data <- testing(data_split)
```


# Cross-validation splits
Here, I'll add the cross validation splits for tuning.  We'll use 5 fold cross-validation here, and we'll stratify by particle class one again.
```{r xval data split}
cv_folds <- vfold_cv(train_data, v=5, strata=particle_class)
cv_folds
```

# Model-based variable importance
```{r variable importance helper}
get_vip <- function(final_fit, ...){
  model_vip <- final_fit %>%
    pull_workflow_fit() %>%
    vi_model(...)
  
  if('Sign' %in% colnames(model_vip)){
    model_vip <- model_vip %>%
      mutate(association = if_else(Sign=='NEG', 'exp', 'site'))
  } else {
    model_vip <- model_vip %>%
      mutate(association = 'mdl')
  }
}

```

```{r generalized variable importance function}
model_variable_importance <-function(final_fit) {
  
  model_type <- class(pull_workflow_spec(final_fit))[[1]]
  
  if(model_type=='logistic_reg'){
    model_vip <- get_vip(final_fit, lambda = final_fit$fit$fit$spec$args$penalty)
  } else if (model_type=='rand_forest' | model_type=='boost_tree'){
    model_vip <- get_vip(final_fit)
  } else {
    stop('Model-based variable importance only supported for logistic regression, random forest, and boost models.')
  }
  
  plt <- model_vip %>%
    ggplot(aes(x=fct_reorder(Variable, Importance), y=Importance, fill=association))+
    geom_col() +
    coord_flip() +
    labs(title='Model-based variable importance',
         subtitle=str_c('for model type ', model_type),
         y='model-based importance',
         x='variable')
  
  print(plt)
  
  return(model_vip)
}
```

