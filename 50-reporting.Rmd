---
title: "50_reporting"
output: html_notebook
---

Report the results of the project with relevant performance and modeling considerations.

# Model-based variable importance
```{r model based variable importance helper}
get_vip <- function(final_fit, ...){
  #helper function to model_variable_importance to calculate importance
  #Inputs: final_fit: tidymodels workflow fit
  #        ...: additional parameters for vi_model (from vip)
  #Outputs: dataframe of variable importance
  
  model_vip <- final_fit %>%
    pull_workflow_fit() %>%
    vi_model(...)
  
  if('Sign' %in% colnames(model_vip)){
    model_vip <- model_vip %>%
      mutate(association = if_else(Sign=='NEG', 'exp', 'site'))
  } else {
    model_vip <- model_vip %>%
      mutate(association = 'mdl')
  }
  
  return(model_vip)
}

```

```{r generalized model based variable importance}
model_variable_importance <-function(final_fit) {
  #returns model-specific variable importance with plot 
  #Inputs: final_fit: tidymodels workflow fit
  #Returns: dataframe of variable importance
  #Outputs: shows plot of variable importance
  
  #get the model type because vi_model requires specific parameters
  model_type <- class(pull_workflow_spec(final_fit))[[1]]
  
  #call vi_model based on model type
  if(model_type=='logistic_reg'){
    model_vip <- get_vip(final_fit, lambda = final_fit$fit$fit$spec$args$penalty)
  } else if (model_type=='rand_forest' | model_type=='boost_tree'){
    model_vip <- get_vip(final_fit)
  } else {
    stop('Model-based variable importance only supported for logistic regression, random forest, and boost models.')
  }
  
  #plot
  plt <- model_vip %>%
    ggplot(aes(x=fct_reorder(Variable, Importance), y=Importance, fill=association))+
    geom_col() +
    coord_flip() +
    labs(title='Model-based variable importance',
         subtitle=str_c('for model type ', model_type),
         y='model-based importance',
         x='variable')
  
  print(plt)
  
  return(model_vip)
}
```
