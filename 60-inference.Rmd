---
title: "60_inference"
output: html_notebook
---

Provide a framework for predicting across multiple models


#Load models and relevant prediction data (from Box - this information will probably be stored as a .RData object)

#Load relevant prediction data from Box

# Validate prediction 
```{r validate prediction dataframe }
#uses function defined in 10 to validate the data to be predicted on
validate_data(pred_frame)

```

# Predict using all loading models

```{r predict on the data using the provided models}

predict_with_models <- function (model_workflow, model_best_params, test_data) {
  
  #finalize workflow with model hyperparameters
  model_final_wf <- model_workflow %>%
    finalize_workflow(model_best_params)
  model_final_wf

  #using final workflow, fit on test data
  final_fit <- model_final_wf %>%
    fit(data = test_data)

  #create the training prediction data frames
  model_training_preds <- get_prediction_dataframes(final_fit, test_data)


  assert(model_training_preds, within_bounds(0,1), .pred_site, 
       description = "Predicition probabilities must be between 0 and 1")
  assert(model_training_preds, within_bounds(0,1), .pred_exp, 
       description = "Predicition probabilities must be between 0 and 1")
  
  
  assert(model_training_preds, (in_set(c("exp", "site") ) ), .pred_class, 
       description = "Predicition must be experimental or site")
  
  ##May not be a known results so this may not exists
    assert(model_training_preds, (in_set(c("exp", "site") ) ), particle_class, 
       description = "Predicition must be experimental or site")

}
```

#Identify particles which require review 

```{r identify particles of concern}
review_particles <-function (pred_frame, lower_bound = 0.49, upper_bound = 0.51) {
  
  ##model thought it was a particle class with more than 50% confidence and got it incorrect
  mismatched_particles <- pred_frame %>%
    filter(particle_class = "exp" & .pred_site >= 0.5 ) %>%
    filter(particle_class = "site" & .pred_exp >= 0.5 )
  
  ##model was unsure about a particle's class
  questionable_particles <- pred_frame %>%
    filter(.pred_exp >= lower_bound & .pred_exp <= upper_bound ) %>%
    filter(.pred_site >= lower_bound & .pred_site <= upper_bound )
}
```

#Output the percentage of microdebitage estimated in the sample
